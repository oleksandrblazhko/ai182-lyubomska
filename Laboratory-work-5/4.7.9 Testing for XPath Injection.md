### Тестування ін’єкції IMAP SMTP
| ID |
| ---- |
| WSTG-INPV-10 |

### Резюме
Ця загроза впливає на всі програми, які спілкуються з поштовими серверами (IMAP/SMTP), як правило, програми веб-пошти. Метою цього тесту є перевірка здатності вводити довільні команди IMAP/SMTP у поштові сервери через те, що вхідні дані не очищаються належним чином.

Метод ін’єкції IMAP/SMTP ефективніший, якщо поштовий сервер не доступний безпосередньо з Інтернету. Якщо можливий повний зв’язок із внутрішнім поштовим сервером, рекомендується проводити пряме тестування.

Ін’єкція IMAP/SMTP дає змогу отримати доступ до поштового сервера, який інакше був би недоступний безпосередньо з Інтернету. У деяких випадках ці внутрішні системи не мають того самого рівня безпеки інфраструктури та захисту, який застосовується до зовнішніх веб-серверів. Тому результати поштового сервера можуть бути більш уразливими до атак кінцевих користувачів
На рисунку 1 зображено потік трафіку, який зазвичай спостерігається під час використання технологій веб-пошти. На етапах 1 і 2 користувач взаємодіє з клієнтом веб-пошти, тоді як на етапі 2 тестувальник обходить клієнт веб-пошти та безпосередньо взаємодіє з внутрішніми поштовими серверами.

Ця техніка допускає широкий спектр дій і атак. Можливості залежать від типу та обсягу впровадження та технології поштового сервера, що тестується.

Нижче наведено кілька прикладів атак із застосуванням технології ін’єкції IMAP/SMTP.

<br>Експлуатація вразливостей у протоколі IMAP/SMTP
<br>Ухилення від обмежень програми
<br>Ухилення від процесу автоматизації
<br>Витік інформації
<br>Реле/СПАМ

### Цілі тесту
#### Визначте точки впровадження IMAP/SMTP.
Зрозумійте потік даних і структуру розгортання системи.
Оцініть вплив ін’єкції.
Як тестувати
Виявлення вразливих параметрів
Щоб виявити вразливі параметри, тестувальник повинен проаналізувати здатність програми обробляти вхідні дані. Тестування перевірки вхідних даних вимагає, щоб тестувальник надсилав фальшиві або шкідливі запити на сервер і аналізував відповідь. У захищеній програмі відповіддю має бути помилка з певною відповідною дією, яка повідомляє клієнту, що щось пішло не так. У вразливій програмі зловмисний запит може бути оброблено серверною програмою, яка відповість HTTP 200 OKвідповідним повідомленням.

Важливо відзначити, що запити, які надсилаються, повинні відповідати технології, яка тестується. Надсилання рядків SQL-ін’єкцій для сервера Microsoft SQL, коли використовується сервер MySQL, призведе до помилкових позитивних відповідей. У цьому випадку надсилання зловмисних команд IMAP є modus operandi, оскільки IMAP є основним протоколом, який тестується.
Слід використовувати такі спеціальні параметри IMAP:

| На сервері IMAP | На сервері SMTP |
| ---- | ---- |
| Аутентифікація | Emissor email |
| операції з поштовими скриньками (список, читання, створення, видалення, перейменування) | Електронна адреса призначення |
| операції з повідомленнями (читання, копіювання, переміщення, видалення) | Тема |
| Відключення | Тіло повідомлення |
| | Прикріплені файли |

У цьому прикладі параметр «mailbox» перевіряється шляхом маніпулювання всіма запитами з параметром у:

http://<webmail>/src/read_body.php?mailbox=INBOX&passed_id=46106&startMessage=1

Можна використати наступні приклади.

Призначте нульове значення параметру:
http://<webmail>/src/read_body.php?mailbox=&passed_id=46106&startMessage=1

Замініть значення випадковим значенням:
http://<webmail>/src/read_body.php?mailbox=NOTEXIST&passed_id=46106&startMessage=1

Додайте до параметра інші значення:
http://<webmail>/src/read_body.php?mailbox=INBOX PARAMETER2&passed_id=46106&startMessage=1

Додайте нестандартні спеціальні символи (наприклад: \, ', ", @, #, !, |):
http://<webmail>/src/read_body.php?mailbox=INBOX"&passed_id=46106&startMessage=1

Виключіть параметр:
http://<webmail>/src/read_body.php?passed_id=46106&startMessage=1

Кінцевий результат вищевказаного тестування дає тестувальнику три можливі ситуації: S1 – Програма повертає код помилки/повідомлення S2 – Програма не повертає код помилки/повідомлення, але не виконує запитану операцію S3 – Програма виконує не повертає код/повідомлення про помилку та нормально виконує запитувану операцію

Ситуації S1 і S2 представляють успішне впровадження IMAP/SMTP.

Метою зловмисника є отримання відповіді S1, оскільки це вказує на те, що програма вразлива до ін’єкції та подальших маніпуляцій.

Припустімо, що користувач отримує заголовки електронної пошти за допомогою такого запиту HTTP:

http://<webmail>/src/view_header.php?mailbox=INBOX&passed_id=46105&passed_ent_id=0

Зловмисник може змінити значення параметра INBOX, ввівши символ "(%22 за допомогою кодування URL):

http://<webmail>/src/view_header.php?mailbox=INBOX%22&passed_id=46105&passed_ent_id=0

У цьому випадку відповіддю заявки може бути:

ERROR: Bad or malformed request.
Query: SELECT "INBOX""
Server responded: Unexpected extra arguments to Select
Ситуацію S2 складніше успішно перевірити. Тестер повинен використати сліпу ін’єкцію команди, щоб визначити, чи є сервер уразливим.

З іншого боку, остання ситуація (S3) не має значення в цьому пункті.

Список уразливих параметрів

Порушена функціональність
Тип можливого впровадження (IMAP/SMTP)
  
### Розуміння потоку даних і структури розгортання клієнта
Після визначення всіх уразливих параметрів (наприклад, passed_id), тестувальник повинен визначити, який рівень впровадження можливий, а потім розробити план тестування для подальшого використання програми.

У цьому тестовому випадку ми виявили, що параметр програми passed_idвразливий і використовується в такому запиті:

http://<webmail>/src/read_body.php?mailbox=INBOX&passed_id=46225&startMessage=1

Використовуючи наступний тестовий приклад (надання алфавітного значення, коли потрібне числове значення):

http://<webmail>/src/read_body.php?mailbox=INBOX&passed_id=test&startMessage=1

створить таке повідомлення про помилку:

ERROR : Bad or malformed request.
Query: FETCH test:test BODY[HEADER]
Server responded: Error in IMAP command received by server.
У цьому прикладі повідомлення про помилку повернуло назву виконаної команди та відповідні параметри.

В інших ситуаціях повідомлення про помилку ( not controlledпрограмою) містить назву виконаної команди, але читання відповідного RFC дозволяє тестувальнику зрозуміти, які інші можливі команди можна виконати.

Якщо програма не повертає описових повідомлень про помилку, тестувальник повинен проаналізувати уражену функцію, щоб вивести всі можливі команди (і параметри), пов’язані з вищезгаданою функціональністю. Наприклад, якщо у функції створення поштової скриньки було виявлено вразливий параметр, логічно припустити, що вразливою командою IMAP є CREATE. Згідно з RFC, CREATEкоманда приймає один параметр, який визначає ім’я поштової скриньки для створення.

Список задіяних команд IMAP/SMTP

Тип, значення та кількість параметрів, які очікуються відповідними командами IMAP/SMTP

### Введення команд IMAP/SMTP
  Після того, як тестувальник визначив уразливі параметри та проаналізував контекст, у якому вони виконуються, наступним етапом є використання функціональності.

Цей етап має два можливі результати:

Ін’єкція можлива в неавтентифікованому стані: уражена функція не потребує автентифікації користувача. Доступні впроваджені команди (IMAP) обмежені такими: CAPABILITY, NOOP, AUTHENTICATE, LOGINі LOGOUT.
Ін’єкція можлива лише в автентифікованому стані: для успішного використання потрібно, щоб користувач пройшов повну автентифікацію перед продовженням тестування.
У будь-якому випадку типова структура ін’єкції IMAP/SMTP така:

Заголовок: закінчення очікуваної команди;
Тіло: введення нової команди;
Нижній колонтитул: початок очікуваної команди.
Важливо пам’ятати, що для виконання команди IMAP/SMTP попередню команду потрібно завершити %0d%0aпослідовністю CRLF ().

Припустімо, що на етапі визначення вразливих параметрів зловмисник виявляє, що параметр message_idу наступному запиті є вразливим:

http://<webmail>/read_email.php?message_id=4791

Припустімо також, що результат аналізу, виконаного на етапі 2 («Розуміння потоку даних і структури розгортання клієнта»), визначив команду та аргументи, пов’язані з цим параметром, як:

FETCH 4791 BODY[HEADER]

У цьому сценарії структура ін’єкції IMAP буде такою:

http://<webmail>/read_email.php?message_id=4791 BODY[HEADER]%0d%0aV100 CAPABILITY%0d%0aV101 FETCH 4791

Що створить такі команди:

???? FETCH 4791 BODY[HEADER]
V100 CAPABILITY
V101 FETCH 4791 BODY[HEADER]
де:

Header = 4791 BODY[HEADER]
Body   = %0d%0aV100 CAPABILITY%0d%0a
Footer = V101 FETCH 4791
Список задіяних команд IMAP/SMTP

Довільне введення команд IMAP/SMTP
